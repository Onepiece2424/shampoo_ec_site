---
title: "Stripeã‚’ç”¨ã„ãŸæ±ºæ¸ˆå‡¦ç†ã®å®Ÿè£…æ–¹æ³•â‘¡"
emoji: "ğŸ¦"
type: "tech"
topics: ["react", "rails", "Stripe"]
published: true
---
### èƒŒæ™¯

[å‰å›ã®è¨˜äº‹](https://zenn.dev/kingdom0927/articles/6fa194f2c463b8)ã§ã€Stripeã‚’ç”¨ã„ãŸã€ŒCheckoutã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã‹ã‚‰æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹å®Ÿè£…æ–¹æ³•ã€ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚ä»Šå›ã¯ãã®ç¶šãã§ã€Stripeã®æ±ºæ¸ˆå®Œäº†å¾Œã®å‡¦ç†ã®å®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ã“ã‚Œã‹ã‚‰Stripeã®æ±ºæ¸ˆå®Œäº†å¾Œã®å‡¦ç†ã‚’å®Ÿè£…ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

&nbsp;
### æ±ºæ¸ˆå‡¦ç†ã®æµã‚Œï¼ˆå‰å›ã®ç¶šãï¼‰

å‰å›ã¯ã€æ±ºæ¸ˆå‡¦ç†ã®å¤§ã¾ã‹ãªæµã‚Œã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚ä»Šå›ã¯ã€æ±ºæ¸ˆå‡¦ç†å®Œäº†å¾Œã®æµã‚Œã‚’è¨˜è¼‰ã„ãŸã—ã¾ã™ã€‚å¤§ã¾ã‹ãªæµã‚Œã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

â‘ é¡§å®¢ãŒè³¼å…¥ã‚’å®Œäº†ã™ã‚‹æº–å‚™ãŒã§ãã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ–°ã—ã„ Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆWebã‚µã‚¤ãƒˆã®è³¼å…¥è€…ã«å¯¾ã™ã‚‹å˜ä¸€ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ãŸã¯ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã®ã“ã¨ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚ï¼ˆå‰å›å®Ÿè£…æ¸ˆã¿ï¼‰

â‘¡Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€é¡§å®¢ã‚’ Stripe ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§æä¾›ã™ã‚‹æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ URL ã‚’æä¾›ã—ã¾ã™ã€‚ï¼ˆå‰å›å®Ÿè£…æ¸ˆã¿ï¼‰

â‘¢é¡§å®¢ã¯æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«æ±ºæ¸ˆæƒ…å ±ã‚’å…¥åŠ›ã—ã€å–å¼•ã‚’å®Œäº†ã—ã¾ã™ã€‚ï¼ˆå‰å›å®Ÿè£…æ¸ˆã¿ï¼‰

â‘£å–å¼•çµ‚äº†å¾Œã€[Webhook](https://stripe.com/docs/webhooks) ã¯Â [checkout.session.completed](https://stripe.com/docs/api/events/types#event_types-checkout.session.completed)Â ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦[æ³¨æ–‡ã®ãƒ•ãƒ«ãƒ•ã‚£ãƒ«ãƒ¡ãƒ³ãƒˆã‚’å®Ÿè¡Œ](https://stripe.com/docs/payments/checkout/fulfill-orders)ã—ã¾ã™ã€‚**ï¼ˆä»Šå›ã¯ã“ã“ã‹ã‚‰å®Ÿè£…ã€‚ï¼‰**

â‘¤Webhook ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œçŸ¥ã—ã€æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆãƒ»ä¿å­˜ã€‚

ã“ã“ã§å‡ºã¦ããŸ Webhook ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

Webhookã¨ã¯ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–“ã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚„é€šçŸ¥ã‚’å¯èƒ½ã«ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä»Šå›ã®å ´åˆã€checkout.session.completed ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ãŒç™ºç”Ÿã—ãŸå ´åˆã«äº‹å‰ã«æŒ‡å®šã•ã‚ŒãŸURLï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€‚ä»Šå›ã®å ´åˆã€localhost:3010/api/v1/webhooks ï¼‰ã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã™ã€‚ã“ã®URLã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹å´ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæä¾›ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡æ–¹æ³•ã¯ã€é€šå¸¸ã¯HTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å½¢å¼ã§ã™ã€‚

ã“ã“ã§ã€æ±ºæ¸ˆå®Œäº†å¾Œã®å‡¦ç†ã®å®Ÿè£…æ–¹æ³•ã‚’ç´¹ä»‹ã™ã‚‹å‰ã«ã€Stripe CLIã‚’ä½¿ç”¨ã—ã€Stripeã®Webhookã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã«è»¢é€ã—ã€Webhook ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

**`stripe listen`** ã‚³ãƒãƒ³ãƒ‰ã§ã€Strip ã® Webhook ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ï¼ˆstripe listen ã‚³ãƒãƒ³ãƒ‰ã«ã¤ã„ã¦ã¯[ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯](https://stripe.com/docs/webhooks/test?locale=ja-JP)ã‚’å‚ç…§ã€‚ï¼‰

ã‚³ãƒãƒ³ãƒ‰ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

```ruby:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ stripe listen --forward-to localhost:3010/api/v1/webhooks
```

æ¬¡ã«ã€â‘£ã®å®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

&nbsp;
### æ³¨æ–‡ã®ãƒ•ãƒ«ãƒ•ã‚£ãƒ«ãƒ¡ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‡¦ç†ã‚’ä½œæˆ

[ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯](https://stripe.com/docs/payments/checkout/fulfill-orders)ã‚’å‚è€ƒã«ã€æ³¨æ–‡ã®ãƒ•ãƒ«ãƒ•ã‚£ãƒ«ãƒ¡ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãšã€Stripeã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä»Šå›ã®å ´åˆã€checkout.session.completed ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã‚’å—ä¿¡ã™ã‚‹ãŸã‚ã®APIï¼ˆrails ã§ã„ã†controllerã®ã“ã¨ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚

å®Ÿè£…å†…å®¹ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚



```ruby:app/controllers/api/v1/webhooks_controller.rb
class Api::V1::WebhooksController < ApplicationController

  def create
    payload = request.body.read
    sig_header = request.env['HTTP_STRIPE_SIGNATURE']
    endpoint_secret = Rails.application.credentials.dig(:stripe, :endpoint_secret)
    event = nil

    begin
      event = Stripe::Webhook.construct_event(
        payload, sig_header, endpoint_secret
      )

    rescue JSON::ParserError, Stripe::SignatureVerificationError => e
      Rails.logger.debug e
      status 400
      return
    end

    case event.type
    when 'checkout.session.completed'
      session = event.data.object
      user = User.find(session.client_reference_id)
      cart_items = user.cart.cart_items.not_order_confirm
      return unless user

    # ã“ã“ã«æ³¨æ–‡å†…å®¹ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…äºˆå®š

    end
  end
end
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

**`create`** ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Šã€Stripeã®Webhookã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**`request.body.read`** ã¯ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒœãƒ‡ã‚£ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Šã¾ã™ã€‚Stripeã‹ã‚‰ã®Webhookã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‰ãŒã“ã“ã§å–å¾—ã•ã‚Œã¾ã™ã€‚

**`request.env['HTTP_STRIPE_SIGNATURE']`** ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Stripeã®ç½²åã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã®ç½²åã¯ã€Stripeã‹ã‚‰ã®é€šçŸ¥ãŒæ­£å½“ãªã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ï¼ˆStripe ã®ç½²åã«ã¤ã„ã¦ã¯[ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯](https://stripe.com/docs/webhooks/signatures?locale=ja-JP)å‚ç…§ã€‚ï¼‰

**`Rails.application.credentials.dig(:stripe, :endpoint_secret)`** ã¯ã€Stripeã®èªè¨¼ç”¨ã®ç§˜å¯†éµï¼ˆsecret_keyï¼‰ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã®èªè¨¼ç”¨ã®ç§˜å¯†éµï¼ˆsecret_keyï¼‰ã¯ã€Stripeã‹ã‚‰ã®é€šçŸ¥ã®æ¤œè¨¼ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

**`Stripe::Webhook.construct_event`** ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€Stripeã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã€ç½²åã€èªè¨¼ç”¨ã®ç§˜å¯†éµï¼ˆsecret_keyï¼‰ã‚’å…ƒã« event ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚event ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€Stripeã‹ã‚‰ã®é€šçŸ¥ã«é–¢é€£ã™ã‚‹æƒ…å ±ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚

å—ã‘å–ã£ãŸ event.type ãŒ **checkout.session.completed** ã®æ™‚ã€Stripeã® event ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã“ã®ã‚ã¨ä½œæˆã™ã¹ãæ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã«å¿…è¦ãªã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆsessionï¼‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆuserï¼‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã¤ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ï¼ˆcart_itemsï¼‰ã‚’å–å¾—ã—ã¾ã™ã€‚

ã¤ã¾ã‚Šã€ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€Stripeã®Webhookã‚’å—ã‘å–ã‚Šã€æ±ºæ¸ˆå‡¦ç†ãŒå®Œäº†ã—ãŸå ´åˆã«æ³¨æ–‡æƒ…å ±ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®æº–å‚™ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚



```ruby:config/routes.rb
Rails.application.routes.draw do
  namespace :api do
    namespace :v1 do

      -- çœç•¥ --

      resources :webhooks, only: [:create]
    end
  end
end
```

&nbsp;
### æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆãƒ»ä¿å­˜

æœ€å¾Œã«ã€æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆOrderï¼‰ã‚’ä½œæˆã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚å®Ÿè£…çµæœãŒä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚



```ruby:app/controllers/api/v1/webhooks_controller.rb
class Api::V1::WebhooksController < ApplicationController

  def create
    payload = request.body.read
    sig_header = request.env['HTTP_STRIPE_SIGNATURE']
    endpoint_secret = Rails.application.credentials.dig(:stripe, :endpoint_secret)
    event = nil

    begin
      event = Stripe::Webhook.construct_event(
        payload, sig_header, endpoint_secret
      )
    rescue JSON::ParserError, Stripe::SignatureVerificationError => e
      Rails.logger.debug e
      status 400
      return
    end

    case event.type
    when 'checkout.session.completed'
      session = event.data.object
      user = User.find(session.client_reference_id)
      cart_items = user.cart.cart_items.not_order_confirm
      return unless user

      # æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
      ApplicationRecord.transaction do
        order = Order.create_order(session)
        session_with_expand = Stripe::Checkout::Session.retrieve({ id: session.id, expand: ['line_items'] })
        OrderAddress.create_order_address(session, session_with_expand, order)
        CartItem.invalidate_cart_items(cart_items)
      end

      render json: { session: session }, status: :ok
    end
  end
end
```



```ruby:app/models/cart_item.rb
class CartItem < ApplicationRecord
  belongs_to :cart
  belongs_to :item

  scope :not_order_confirm, -> { where(invalidated_at: nil) }

  class << self
    def invalidate_cart_items(cart_items)
      cart_items.each do |cart_item|
        cart_item.update(invalidated_at: Time.zone.now)
      end
    end
  end
end
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

ApplicationRecord.transaction do ~ end ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã®ä¸­ã§ã€Orderï¼ˆæ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ï¼‰,OrderAddressï¼ˆãŠå±Šã‘å…ˆãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€CartItemã«ã¯æ™‚åˆ»ãŒå…¥ã‚‹ã¨è«–ç†å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ãª invalidated_at ã‚«ãƒ©ãƒ ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚Šã€æ³¨æ–‡ç¢ºå®šã—ãŸã‚‰ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ï¼ˆCartItemï¼‰ãŒè«–ç†å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸ŠãŒæ±ºæ¸ˆå®Œäº†å¾Œã®å®Ÿè£…æ–¹æ³•ã®è§£èª¬ã«ãªã‚Šã¾ã™ã€‚

&nbsp;
### ã¾ã¨ã‚

ä»Šå›ã¯ã€Stripeã®æ±ºæ¸ˆå®Œäº†å¾Œã®å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã ã‘ã ã¨ã¡ã‚‡ã£ã¨é›£ã—ã„éƒ¨åˆ†ãŒã‚ã‚Šã¾ã—ãŸãŒã€ã„ã‚ã‚“ãªæ–¹ã€…ã®å®Ÿè£…ã—ãŸè¨˜äº‹ã‚’å‚è€ƒã«ã™ã‚‹ã“ã¨ã§ãªã‚“ã¨ã‹å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ä»Šå¾Œã¯ã€ä»–ã®æ”¯æ‰•ã„æ–¹æ³•ã§ã®æ±ºæ¸ˆã‚’å®Ÿè£…ã§ãã‚‹ã‹ãƒˆãƒ©ã‚¤ã—ã¦ã„ããŸã„ã§ã™ã€‚
