---
title: "Stripeã‚’ç”¨ã„ãŸæ±ºæ¸ˆå‡¦ç†ã®å®Ÿè£…æ–¹æ³•â‘ "
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react", "rails", "Stripe"]
published: true
---
### èƒŒæ™¯

ä»Šå›ã¯ã€react,railsã‚¢ãƒ—ãƒªã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã®ã€ŒStripeã€ã‚’ç”¨ã„ãŸæ±ºæ¸ˆå‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚ã“ã‚Œã‹ã‚‰æ±ºæ¸ˆå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚Stripeã®ä½¿ç”¨ã‚’æ¤œè¨ã—ã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

&nbsp;
### å®Ÿè£…æ–¹æ³•

ã¾ãšã€å¤§ã¾ã‹ãªå®Ÿè£…æ‰‹é †ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

â‘ Stripeã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
â†“
â‘¡æ±ºæ¸ˆå‡¦ç†ã®ä½œæˆ
â†“
â‘¢æ±ºæ¸ˆå®Œäº†å¾Œã€æ³¨æ–‡å†…å®¹ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆåˆ¥ã®è¨˜äº‹ã§ç´¹ä»‹äºˆå®šï¼‰

ä»Šå›ã¯ã€â‘¢ã¾ã§èª¬æ˜ã™ã‚‹ã¨ã¨ã¦ã‚‚èª¬æ˜ãŒé•·ããªã£ã¦ã—ã¾ã†ã®ã§ã€â‘ ,â‘¡ã®å®Ÿè£…æ‰‹é †ã®ã¿ã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

ã¾ãšã€Stripeã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«Stripeã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

&nbsp;
### Stripeã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšã¯ã€[ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯](https://stripe.com/jp)ã‹ã‚‰Stripeã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã«æ–°è¦ç™»éŒ²ã—ã¾ã™ã€‚

æ¬¡ã«ã€rails ã® Credentials ã¨ã„ã†**æ©Ÿå¯†æƒ…å ±ã‚’æš—å·åŒ–ã—ã€å®‰å…¨ã«ä¿è­·ã™ã‚‹æ©Ÿèƒ½**ã‚’ç”¨ã„ã¦ã€å…¬é–‹éµã‚„ç§˜å¯†éµãªã©ã®æ©Ÿå¯†æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ã„ãã¾ã™ã€‚

Credentials ã®ä½œæˆã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```ruby:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ EDITOR="vi" bin/rails credentials:edit -e development
```

ä»Šå›ã¯ã€-e development ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã“ã¨ã§developmentç’°å¢ƒã®ã¿ã®è¨­å®šã¨ã—ã¦ç’°å¢ƒè¨­å®šã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`config/credentials/development.yml.enc`ï¼ˆå…¬é–‹éµï¼‰ã¨`config/credentials/development.key`ï¼ˆç§˜å¯†éµï¼‰ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

ãã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ãªç”»é¢ã«ãªã‚‹ã®ã§ vimã‚³ãƒãƒ³ãƒ‰ã‚’ç”¨ã„ã¦å…¬é–‹éµï¼ˆpublishable_keyï¼‰ã¨ç§˜å¯†éµï¼ˆsecret_keyï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ï¼ˆè¨­å®šæ–¹æ³•ã¯ vim ã‚³ãƒãƒ³ãƒ‰ã§æ¤œç´¢ã™ã‚‹ã¨å¤šãã®è¨˜äº‹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ï¼‰

```ruby
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# ã“ã“ã‚‰ã¸ã‚“ã«Stripeã®å…¬é–‹éµã¨ç§˜å¯†éµã®è¨˜è¿°ã‚’ã™ã‚‹ã€‚
```

è¨­å®šã™ã¹ãå…¬é–‹éµï¼ˆpublishable_keyï¼‰ã¨ç§˜å¯†éµï¼ˆsecret_keyï¼‰ã®å„å€¤ã¯ã€Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > ãƒ›ãƒ¼ãƒ  ã«è¨˜è¼‰ã—ã¦ã‚ã‚Šã¾ã™ã€‚ï¼ˆä¸‹è¨˜ç”»åƒã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ï¼‰

å…¬é–‹éµã¯ã€Œå…¬é–‹å¯èƒ½ã‚­ãƒ¼ã€ã®å€¤ã€ç§˜å¯†éµã¯ã€Œã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã€ã®å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

![](https://storage.googleapis.com/zenn-user-upload/e1e5ac66ca67-20230716.png)

```ruby
# aws:
#   access_key_id: 123
#   secret_access_key: 345

stripe:
  publishable_key: pk_test_xxxxx
  secret_key: sk_test_xxxxx
```

è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ rails c ã§ é©åˆ‡ã«è¨­å®šã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚ã‚³ãƒãƒ³ãƒ‰ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

```ruby:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ rails c

[1] pry(main)> Rails.application.credentials.dig(:stripe, :publishable_key)
=> "pk_test_51NN..."

[2] pry(main)> Rails.application.credentials.dig(:stripe, :secret_key)
=> "sk_test_51NN..."
```

ã•ã‚‰ã«ã€ã‚µãƒ¼ãƒèµ·å‹•æ™‚ã«è¨­å®šã—ãŸå…¬é–‹éµï¼ˆpublishable_keyï¼‰ã¨ç§˜å¯†éµï¼ˆsecret_keyï¼‰ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ãŸã‚ã« Stripeå°‚ç”¨ã® config/initializers/stripe.rb ã‚’ä½œæˆã—ã¾ã™ã€‚

`config/initializers/`Â ã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹ã¨ã€`config/initializers/`Â é…ä¸‹ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€rails ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚

èª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®èª­ã¿è¾¼ã¿ï¼†gemã®èª­ã¿è¾¼ã¿ãŒçµ‚ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚

ã¾ãŸã€`config/initializers/`Â é…ä¸‹ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€é–‹ç™ºç’°å¢ƒãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒãƒ»æœ¬ç•ªç’°å¢ƒå…¨ã¦ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚

ä½œæˆã™ã¹ãconfig/initializers/stripe.rb ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚


```ruby:config/initializers/stripe.rb
Stripe.api_key = Rails.application.credentials.dig(:stripe, :secret_key)
Stripe.api_version = '2022-11-15'
```

Stripe.api_versionã¯ã€[ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯](https://stripe.com/docs/api/versioning)ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸Šã§Stripeã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§ã®åˆæœŸè¨­å®šã¯å®Œäº†ã¨ãªã‚Šã¾ã™ã€‚æ¬¡ã«æ±ºæ¸ˆå‡¦ç†ã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

&nbsp;
### æ±ºæ¸ˆå‡¦ç†ã®ä½œæˆ

Stripeã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã€Œ[Checkoutï¼ˆæ”¯æ‰•ã„ï¼‰ã®ä»•çµ„ã¿](https://stripe.com/docs/payments/checkout/how-checkout-works?locale=ja-JP)ã€ã¨ã„ã†ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã€æ±ºæ¸ˆå‡¦ç†ã®æµã‚Œã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å¤§ã¾ã‹ãªå‡¦ç†ã®æµã‚Œã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

â‘ é¡§å®¢ãŒè³¼å…¥ã‚’å®Œäº†ã™ã‚‹æº–å‚™ãŒã§ãã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ–°ã—ã„ Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆWebã‚µã‚¤ãƒˆã®è³¼å…¥è€…ã«å¯¾ã™ã‚‹å˜ä¸€ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ãŸã¯ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã®ã“ã¨ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚

â‘¡Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€é¡§å®¢ã‚’ Stripe ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§æä¾›ã™ã‚‹æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ URL ã‚’æä¾›ã—ã¾ã™ã€‚

â‘¢é¡§å®¢ã¯æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«æ±ºæ¸ˆæƒ…å ±ã‚’å…¥åŠ›ã—ã€å–å¼•ã‚’å®Œäº†ã—ã¾ã™ã€‚

â‘£å–å¼•çµ‚äº†å¾Œã€[Webhook](https://stripe.com/docs/webhooks)ã¯Â [checkout.session.completed](https://stripe.com/docs/api/events/types#event_types-checkout.session.completed)Â ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦[æ³¨æ–‡ã®ãƒ•ãƒ«ãƒ•ã‚£ãƒ«ãƒ¡ãƒ³ãƒˆï¼ˆå•†å“ã‚’å—æ³¨ã—ã¦ã‹ã‚‰ç™ºé€ã™ã‚‹ã¾ã§ã®ä¸€é€£ã®å·¥ç¨‹ï¼‰ã‚’å®Ÿè¡Œ](https://stripe.com/docs/payments/checkout/fulfill-orders)ã—ã¾ã™ã€‚

Checkoutï¼ˆæ”¯æ‰•ã„ï¼‰ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚ŠæŠœç²‹ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/2f48e1295e25-20230716.png)

å¤§ã¾ã‹ãªCheckoutï¼ˆæ”¯æ‰•ã„ï¼‰ã®ä»•çµ„ã¿ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ãŒã§ããŸã®ã§ã€ã¾ãš React,JavaScriptå´ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

å®Ÿè£…ã™ã¹ãå†…å®¹ã¯ã€Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹å‡¦ç†ã® API ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã™ã€‚å®Ÿè£…å†…å®¹ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚



```jsx:frontend/src/components/cart/Cart.jsx
import React, { useState, useEffect } from 'react'
import { useDispatch, useSelector } from 'react-redux';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';
import { Card, CardContent, CardMedia, Typography, Grid, Button } from '@mui/material';
import { fetchCartData } from '../../apis/fetchCartData';
import { confirmedOrder } from '../../apis/confirmedOrder';
import logo from '../..//20230416_ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼ç”»åƒ.jpg'

const Cart = () => {

  -- çœç•¥ --

  // æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸é·ç§»
  const GoToOrderPage = () => {
    confirmedOrder()
  }

  return (
    <div style={{ padding: '10px'}}>

      -- çœç•¥ --

      <div style={{ margin: '20px', display: 'flex' }}>
        <Typography style={{ minWidth: '50%' }}>åˆè¨ˆé‡‘é¡ï¼šÂ¥{cart.total_price}</Typography>
        <Button variant="contained" style={{ minWidth: '50%' }} onClick={GoToOrderPage} disabled={cart.total_price <= 0}>æ³¨æ–‡æ‰‹ç¶šãã¸</Button>
      </div>
    </div>
  )
}

export default Cart
```

ä¸Šè¨˜ã§ã¯ã€ä½œæˆã—ãŸã€Œæ³¨æ–‡æ‰‹ç¶šãã¸ã€ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã“ã¨ã§ã€GoToOrderPageé–¢æ•°ã®ä¸­ã«ã‚ã‚‹ confirmedOrder é–¢æ•°ï¼ˆæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ãŸã‚ã®å‡¦ç†ï¼‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹å‡¦ç†ã®APIï¼ˆä¸Šè¨˜ã®checkouts_controller.rb ã® createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’å®Ÿè¡Œã•ã›ã‚‹ JavaScript å´ã®å‡¦ç†ã¯ä¸‹è¨˜ã«ãªã‚Šã¾ã™ã€‚



```jsx:frontend/src/apis/confirmedOrder.js
import axios from 'axios';
import { confirmOrderurl } from '../urls/index'

// æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸
export const confirmedOrder = async() => {
  await axios.post(confirmOrderurl)
  .then(data => {
    window.location.href = data.data.session.url
  }).catch(error => {
    console.log(error);
  });
};
```

ã¾ãŸã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚



```ruby:config/routes.rb
Rails.application.routes.draw do
  namespace :api do
    namespace :v1 do

      -- çœç•¥ --

      resources :checkouts, only: [:create]

    end
  end
end
```

æ¬¡ã«ã€Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®controllerã‚’ä½œæˆã—ã¾ã™ã€‚å®Ÿè£…å†…å®¹ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚



```ruby:app/controllers/api/v1/checkouts_controller.rb
class Api::V1::CheckoutsController < ApplicationController
  before_action :authenticate_api_v1_user!

  # ã“ã“ã«Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…äºˆå®š
end
```

ä»Šå›ã¯ã€devise-token-auth ã¨ã„ã†ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ï¼ˆã‚µãƒ¼ãƒã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚Šãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª°ã§ã‚ã‚‹ã®ã‹ç¢ºèªãƒ»ç‰¹å®šã™ã‚‹ã“ã¨ï¼‰ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ gem ã‚’ç”¨ã„ã¦ã„ã¾ã™ã€‚devise-token-auth ãŒæä¾›ã—ã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã® before_action :authenticate_api_v1_user! ã‚’ç”¨ã„ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã©ã†ã‹åˆ¤æ–­ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

æ¬¡ã«ã€createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ã€Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ä¸‹è¨˜ãŒå®Ÿè£…ã—ãŸCheckout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆå‡¦ç†ã¨ãªã‚Šã¾ã™ã€‚



```ruby:app/controllers/api/v1/checkouts_controller.rb
class Api::V1::CheckoutsController < ApplicationController
  before_action :authenticate_api_v1_user!

  def create
    line_items = current_api_v1_user.line_items_checkout
    session = create_session(line_items)
    render json: { session: session }, status: :ok
  end

  private

  def create_session(line_items)
    Stripe::Checkout::Session.create(
      client_reference_id: current_api_v1_user.id,
      customer_email: current_api_v1_user.email,
      mode: 'payment',
      payment_method_types: ['card'],
      line_items: line_items,
      shipping_address_collection: {
        allowed_countries: ['JP']
      },
      shipping_options: [
        {
          shipping_rate_data: {
            type: 'fixed_amount',
            fixed_amount: {
              amount: 500,
              currency: 'jpy'
            },
            display_name: 'Single rate'
          }
        }
      ],
      success_url: 'æ±ºæ¸ˆæˆåŠŸæ™‚ã«é·ç§»ã•ã›ãŸã„URL',
      cancel_url: "æ±ºæ¸ˆå¤±æ•—æ™‚ã«é·ç§»ã•ã›ãŸã„URL"
    )
  end
end
```



```ruby:app/models/user.rb
class User < ApplicationRecord
  devise :database_authenticatable, :registerable, :recoverable, :rememberable, :validatable, :omniauthable
  include DeviseTokenAuth::Concerns::User

  has_one :cart, dependent: :destroy
  has_many :orders, dependent: :destroy

  -- çœç•¥ --

  def line_items_checkout
    cart.cart_items.not_order_confirm.map do |cart_item|
      {
        quantity: cart_item.quantity,
        price_data: {
          currency: 'jpy',
          unit_amount: cart_item.item.price,
          product_data: {
            name: cart_item.item.name,
            metadata: {
              product_id: cart_item.item_id
            }
          }
        }
      }
    end
  end
end
```

å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

ã¾ãšã€createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‘è¡Œç›®ã® line_items = current_api_v1_user.line_items_checkout ã§ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUserï¼‰ãŒæŒã¤ã‚«ãƒ¼ãƒˆï¼ˆCartï¼‰ã®ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ï¼ˆCartItemã€Itemã¨Cartã‚’é–¢é€£ã¥ã‘ã‚‹ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«å–å¾—ã™ã‚‹ç†ç”±ã¯ã€Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸå•†å“æƒ…å ±ã‚’Stripe å´ã§æŒ‡å®šã•ã‚ŒãŸå½¢ã¨åŒã˜ã‚ˆã†ãªå½¢ã§å–å¾—ã™ã‚‹ãŸã‚ã§ã™ã€‚

ä½œæˆã™ã¹ãCheckout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ï¼ˆ[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://stripe.com/docs/payments/checkout/migrating-prices#%E3%82%A4%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%A2%E3%82%A4%E3%83%86%E3%83%A0%E3%81%AE%E3%82%B5%E3%83%BC%E3%83%90%E5%81%B4%E3%82%B3%E3%83%BC%E3%83%89)ã‚ˆã‚ŠæŠœç²‹ï¼‰

```ruby:Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
session = Stripe::Checkout::Session.create(
  line_items: [{
    name: 'T-shirt',
    description: 'Comfortable cotton t-shirt',
    images: ['https://example.com/t-shirt.png'],
    amount: 2000,
    currency: 'usd',
    price_data: {
      currency: 'usd',
      unit_amount: 2000,
      product_data: {
        name: 'T-shirt',
        description: 'Comfortable cotton t-shirt',
        images: ['https://example.com/t-shirt.png'],
      },
    },
    quantity: 1,
  }],
  mode: 'payment',
  success_url: 'https://example.com/success?session_id={CHECKOUT_SESSION_ID}',
  cancel_url: 'https://example.com/cancel',
)
```

æ¬¡ã«ã€createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼’è¡Œç›® session = create_session(line_items) ã§ã€Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ãã—ã¦ã€createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼“è¡Œç›® render json: { session: session }, status: :ok ã§ã€Javascriptå´ã«è¿”ã—ãŸã„å†…å®¹ã‚’JSONå½¢å¼ã§è¿”ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã¯ã€æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã®URLï¼ˆsession ã®ä¸­ã«ã‚ã‚‹ url ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ï¼‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹ãŸã‚ã«è¡Œãªã£ã¦ã„ã¾ã™ã€‚

ä»¥ä¸ŠãŒStripeã®æ±ºæ¸ˆå‡¦ç†ã®å®Ÿè£…æ–¹æ³•ã«ãªã‚Šã¾ã™ã€‚

ä¸Šè¨˜ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ä¸‹è¨˜ã®æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/33cbb70753ab-20230716.png)

&nbsp;
### ã¾ã¨ã‚

ä»Šå›ã¯ã€react,railsã‚¢ãƒ—ãƒªã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã®ã€ŒStripeã€ã‚’ç”¨ã„ãŸæ±ºæ¸ˆå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã¿ã¾ã—ãŸã€‚

ä»Šå›ã¯Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã‹ã‚‰æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹å‡¦ç†ã®å®Ÿè£…æ–¹æ³•ã¾ã§ã—ã‹è§£èª¬ã§ããªã‹ã£ãŸã®ã§ã€æ¬¡å›ã¯æ±ºæ¸ˆå¾Œã®å‡¦ç†ã®å®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
