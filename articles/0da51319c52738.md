---
title: "devise-token-authã‚’ç”¨ã„ãŸãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã®ä½œæˆâ‘¡"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react", "Ruby", "rails"]
published: false
---

### **ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã®ä½œæˆ**

ã“ã“ã§ã¯ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã®å®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã‚‚[ã“ã¡ã‚‰](https://qiita.com/tomokazu0112/items/5fdd6a51a84c520c45b5#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A2%E3%82%A6%E3%83%88)ã®è¨˜äº‹ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

å®Ÿè£…æ–¹é‡ã¨ã—ã¦ã¯ã€ã¾ãšã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œã« Cookieã¸ä¿å­˜ã—ãŸ access-token, client, uid ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ãŸ HTTPãƒ˜ãƒƒãƒ€ ã‚’ä½œæˆã—ã¾ã™ã€‚

æ¬¡ã«ã€ãã®HTTPãƒ˜ãƒƒãƒ€ ã‚’ç”¨ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã¤ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆUser.last.tokens ãªã©ã§å–å¾—ã§ãã‚‹ token, client_id, created_at , expiry ãªã©ã®æƒ…å ±ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

ã•ã‚‰ã«ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ Cookieã®ä¸­ã«ä¿å­˜ã—ã¦ã„ã‚‹ access-token, client, uid ã‚‚å‰Šé™¤ã—ã¾ã™ã€‚

ä»Šå›ã¯ã€ä¸Šè¨˜ã®ã‚ˆã†ãªæ–¹é‡ã§å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚å®Ÿè£…çµæœã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚



```jsx:frontend/src/components/modules/Header.jsx
import React, { useState } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { styled, useTheme } from '@mui/material/styles';
import { useNavigate } from 'react-router-dom';
import {
  IconButton,
  Drawer,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
} from '@mui/material';
import ChevronLeftIcon from '@mui/icons-material/ChevronLeft';
import ChevronRightIcon from '@mui/icons-material/ChevronRight';
import LockOpenIcon from '@mui/icons-material/LockOpen';
import ExitToAppIcon from '@mui/icons-material/ExitToApp';
import { userSignOut } from '../../apis/userSignOut';

const DrawerHeader = styled('div')(({ theme }) => ({
  display: 'flex',
  alignItems: 'center',
  padding: theme.spacing(0, 1),
  ...theme.mixins.toolbar,
  justifyContent: 'flex-start',
}));

const Header = () => {
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const user = useSelector(state => state.user)
  const dispatch = useDispatch()
  const navigate = useNavigate();

  // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰
  const toggleSidebar = () => {
    setIsSidebarOpen(!isSidebarOpen);
  };

  const handleSignInClick = () => {
    toggleSidebar()
    navigate('/users/sign_in');
  }
  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  const handleSignOutClick = () => {

    // Cookieã‚’å–å¾—
    const cookies = document.cookie.split(';');
    const cookieData = cookies.reduce((data, cookie) => {
      const [key, value] = cookie.trim().split('=');
      data[key] = value;
      return data;
    }, {});

    const access_token = cookieData['access-token'] || null;
    const client = cookieData['client'] || null;
    const uid = cookieData['uid'] || null;

    const headers = {
      'access-token': access_token,
      'client': client,
      'uid': uid
    };

    userSignOut(headers, dispatch);
    toggleSidebar();
  };

  const theme = useTheme();
  const handleDrawerClose = () => {
    toggleSidebar()
  };

  return (
    <>
      <Drawer anchor="right" open={isSidebarOpen} onClose={toggleSidebar}>
        <div className='sidebar'>
          <DrawerHeader>
            <IconButton onClick={handleDrawerClose}>
              {theme.direction === 'rtl' ? <ChevronLeftIcon /> : <ChevronRightIcon />}
            </IconButton>
          </DrawerHeader>
          <List>
            {!user?.accessToken &&
            <ListItem button onClick={handleSignInClick}>
              <ListItemIcon>
                <LockOpenIcon />
              </ListItemIcon>
              <ListItemText primary="ãƒ­ã‚°ã‚¤ãƒ³" />
            </ListItem>
            }
            {user?.accessToken &&
            <ListItem button onClick={handleSignOutClick}>
              <ListItemIcon>
                <ExitToAppIcon />
              </ListItemIcon>
              <ListItemText primary="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" />
            </ListItem>
            }
          </List>
        </div>
      </Drawer>
    </>
  );
};

export default Header;
```

ä¸Šè¨˜ã® Header componentã€€ã§ã¯ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’ä½œæˆã—ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ handleSignOutClick ã¨ã„ã†é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€Cookie ã«ä¿å­˜ã—ã¦ã‚ã‚‹ access-token, client, uid ã‚’å–å¾—ã—ã€ãã‚Œã‚‰ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚‚ã¤HTTPãƒ˜ãƒƒãƒ€ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ãã—ã¦ã€ä½œæˆã—ãŸHTTPãƒ˜ãƒƒãƒ€ã‚’ç”¨ã„ã¦ userSignOut ã¨ã„ã†ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’rails API ã¨ã—ã¦å‘¼ã³å‡ºã™é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚



```jsx:frontend/src/urls/index.js
const DEFAULT_API_LOCALHOST = 'http://localhost:3010/api/v1'

export const logoutIndex = `${DEFAULT_API_LOCALHOST}/auth/sign_out`
```



```jsx:frontend/src/apis/userSignOut.js
import axios from 'axios';
import { logoutIndex } from '../urls/index'
import { deleteUserData } from '../reducks/reducers/user';

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
export const userSignOut = async(headers, dispatch) => {
  await axios.delete(logoutIndex, { headers: headers })
  .then(response => {
    if (navigator.cookieEnabled)
    {
        document.cookie = 'access-token=;max-age=0;';
        document.cookie = 'client=;max-age=0;';
        document.cookie = 'uid=;max-age=0;';
    }
    dispatch(deleteUserData(response.data))
    window.location.reload();
    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸã—ã¾ã—ãŸã€‚')
  }).catch(error => {
    console.log(error);
  });
};
```

ä¸Šè¨˜ã® userSignOut é–¢æ•°ã§ã¯ã€reactå´ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸHTTPãƒ˜ãƒƒãƒ€ã‚’ç”¨ã„ã¦ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®DELETEã‚’å®Ÿè¡Œã—ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã® rails APIã‚’ãŸãŸã„ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€rails API ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒæˆåŠŸã—ãŸã‚‰ ã€Cookie ã«ä¿å­˜ã—ã¦ã„ã‚‹ access-token, client, uid  ã‚‚å‰Šé™¤ã—ã¦ã„ã¾ã™ã€‚



```ruby:config/routes.rb
Rails.application.routes.draw do
  namespace :api do
    namespace :v1 do
      mount_devise_token_auth_for 'User', at: 'auth', controllers: {
        sessions: 'api/v1/auth/sessions'
      }
    end
  end
end
```

ä¸Šè¨˜ã® routes.rb ã§ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†åŒæ§˜ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚‚ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚



```ruby:app/controllers/api/v1/auth/sessions_controller.rb
class Api::V1::Auth::SessionsController < DeviseTokenAuth::SessionsController

  -- çœç•¥ ---

  def destroy
    # èªè¨¼æƒ…å ±ã‚’å«ã‚€ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’å–å¾—
    client_id = request.headers['client']
    uid = request.headers['uid']
    access_token = request.headers['access-token']

    # ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç‰¹å®šã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹
    user = User.find_by_uid(uid)
    user.tokens.delete(client_id) if user

    if user&.save
      render json: { message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚' }
    else
      render json: { errors: ['ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚'] }, status: :unprocessable_entity
    end
  end
end
```

ä¸Šè¨˜ã® sessions_controller.rb ã§ã¯ã€destroyã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

ã“ã“ã§ã¯ã€raectå´ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸHTTPãƒ˜ãƒƒãƒ€ã®ä¸­ã«ã‚ã‚‹ client, uid ã‚’å–å¾—ã—ã€å–å¾—ã—ãŸ uid ã‹ã‚‰ãã® uid ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

ãã—ã¦ã€ãã®ç‰¹å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã¤ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ï¼ˆUser.last.tokens ãªã©ã§å–å¾—ã§ãã‚‹ token, client_id, created_at , expiry ãªã©ã®æƒ…å ±ï¼‰ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸ŠãŒã€devise-token-auth ã‚’ç”¨ã„ãŸ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã®å®Ÿè£…æ–¹æ³•ã®èª¬æ˜ã¨ãªã‚Šã¾ã™ã€‚
